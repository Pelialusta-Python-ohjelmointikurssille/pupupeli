<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="/favicon.ico">
    <title>Pupupeli Level Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/style.css">
    <style>
        td {
            width: 4rem;
            height: 4rem;
            border: 1px solid black;
            text-align: center;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .is-flex-center {
            justify-content: center;
            align-items: center;
        }

        .is-flex-column {
            flex-direction: column;
        }

        #app {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #grid-input-submit-container {
            flex-direction: row;
        }

        .grid-input-submit {
            margin: 0.5rem;
        }

        #grid-width-input,
        #grid-height-input {
            width: 1rem;
            float: right;
        }

        #options-top {
            display: contents;
        }

        #options-left {
            padding: 1rem;
        }

        #options-middle {
            margin: 1rem auto 0rem auto;
        }

        #options {
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #options-container {
            width: 100%;
            max-width: calc(var(--canvas-width)* 1.5);
        }

        #output-field {
            max-width: calc(var(--canvas-width) * 1.5);
            width: 100%;
            margin: 1rem;
        }

        .checkbox {
            margin-left: 1rem;
        }
    </style>
</head>

<body>
    <div id="app" class="is-flex">
        <h1 class="is-flex" style="text-align: center;padding:1rem;">PupuEditor</h1>
        <div id="options-top" class="is-flex is-flex-1 is-flex-center">
            <div id="options" class="is-flex">
                <select id="theme">
                    <option value="pupu">Pupu</option>
                    <option value="robo">Robo</option>
                </select>
                <div class="grid-input-container">
                    <span class="grid-width-input-text">Ruudukon leveys:</span>
                    <input id="grid-width-input" type="text" placeholder="8" value="8"></input>
                </div>
                <div class="grid-input-container">
                    <span class="grid-width-input-text">Ruudukon korkeus:</span>
                    <input id="grid-height-input" type="text" placeholder="8" value="8"></input>
                </div>
            </div>
            <div id="grid-input-submit-container" class="is-flex">
                <button class="grid-input-submit" type="submit" value="Submit" onclick="createTable()">Submit</button>
                <button class="grid-input-submit" type="submit" value="Generate" onclick="generateTaskOutput()">Generate</button>
                <button id="save-button" class="grid-input-submit is-hidden" type="submit" value="Save" onclick="downloadOutput()">Save</button>
            </div>
        </div>
        <div id="options-container" class="is-flex is-flex-column">
            <div id="options-middle" class="is-flex is-flex-1 is-flex-center">
                <div class="checkbox-container is-flex is-flex-center">
                    <input type="checkbox" id="condition1" class="checkbox" name="condition1" value="usedWhile"
                        onclick="this.classList.toggle('checked')">
                    <label for="condition1">käytä while-silmukkaa</label><br>
                </div>
                <div class="checkbox-container is-flex is-flex-center">
                    <input type="checkbox" id="condition2" class="checkbox" name="condition2" value="usedFor"
                        onclick="this.classList.toggle('checked')">
                    <label for="condition2">käytä for-silmukkaa</label><br>
                </div>
                <div class="checkbox-container is-flex is-flex-center">
                    <input type="checkbox" id="condition3" class="checkbox" name="condition3" value="usedInput"
                        onclick="this.classList.toggle('checked')">
                    <label for="condition3">käytä input()</label><br>
                </div>
            </div>
            <div id="options-left" class="is-flex is-flex-1">
                <textarea rows="7" name="task-input" id="task-input" class="is-flex-1" value=""
                    contenteditable></textarea>
            </div>
        </div>
        <div id="app-container" class="is-flex">
            <div id="editor-container">
                <table id="editor-table"></table>
            </div>
        </div>
        <textarea id="output-field" rows="7"></textarea>
    </div>

    <script>
        class Level {
            constructor(description, grid, conditions) {
                this.description = description;
                this.grid = grid;
                this.conditions = conditions;
            }
        }

        function createTable() {

            let width = document.getElementById("grid-width-input").value;
            let height = document.getElementById("grid-height-input").value;
            let table = document.getElementById("editor-table");
            let cell;

            table.innerHTML = '';

            for (x = 0; x < height; x++) {
                table.appendChild(document.createElement("tr"));
                for (y = 0; y < width; y++) {
                    cell = table.children[x].appendChild(document.createElement("td"));
                    cell.dataset.value = "0";
                    cell.innerHTML = '<img src="/src/static/game_assets/background_grass.png"></img>'


                    cell.addEventListener('click', function () {
                        switch (this.dataset.value) {
                            case '0':
                                this.dataset.value = '1';
                                this.innerHTML = '<img src="/src/static/game_assets/porkkana_lapinakyva.png"></img>'
                                break;
                            case '1':
                                this.dataset.value = '2';
                                this.innerHTML = '<img src="/src/static/game_assets/Kivi3.png"></img>'
                                break;
                            case '2':
                                this.innerHTML = '<img src="/src/static/game_assets/background_grass.png"></img>'
                                this.dataset.value = '0';
                                break;
                        }

                    });

                }
            }
        }

        function createGridFromTable() {
            const table = document.getElementById('editor-table');
            const rows = table.rows;
            const grid = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                const rowArray = [];

                for (let j = 0; j < cells.length; j++) {
                    rowArray.push(cells[j].dataset.value);
                }

                grid.push(rowArray);
            }

            return grid;
        }

        function getConditions() {
            let conditions = [];
            let conditionElements = document.getElementsByClassName("checkbox");
            for (x = 0; x < conditionElements.length; x++) {
                if (conditionElements[x].value === "conditionMaxLines") {
                    let maxLinesValue = conditionElements[x].checked ? conditionElements[x].nextElementSibling.children[0].value : false;
                    conditions.push({ condition: conditionElements[x].value, parameter: maxLinesValue });
                } else {
                    conditions.push({ condition: conditionElements[x].value, parameter: conditionElements[x].checked });
                }
            }
            return conditions;
        }

        function generateTaskOutput() {

            const taskDescriptionLines = [];
            document.getElementById("task-input").value.split("\n").forEach((line) => {
                taskDescriptionLines.push(line);
            })
            const taskGameGrid = createGridFromTable();
            const conditions = getConditions();

            // use Level class to get json output
            let output = new Level(taskDescriptionLines, taskGameGrid, conditions);
            let outputField = document.getElementById("output-field");
            outputField.value = customJSONStringify(output);
            // need to fire input event to resize output field
            outputField.dispatchEvent(new Event("input"));

            // show save button after generating task output
            const save_button = document.getElementById("save-button");
            if (save_button.classList.contains("is-hidden")) save_button.classList.toggle("is-hidden");

            // check if array consists of single characters only (relevant for printing our grid nicely)
            function isSingleCharArray(array) {
                return Array.isArray(array) && array.every(item => typeof item === 'string' && item.length === 1);
            }

            // replacer function for JSON.stringify
            function stringifyReplacer(key, value) {
                if (isSingleCharArray(value)) {
                    return `[${value.join(',')}]`;
                }
                return value;
            }

            // remove extra quotes around the single-character arrays
            function customJSONStringify(obj) {
                return JSON.stringify(obj, (key, value) => {
                    let replacedValue = stringifyReplacer(key, value);
                    if (typeof replacedValue === 'string' && replacedValue.startsWith('[')) {
                        return replacedValue;
                    }
                    return value;
                }, 2).replace(/"(\[.*?\])"/g, '$1');
            }
        }

        function clickConditionBox(div) {
            div.classList.toggle('checked');
            div.parentNode.classList.toggle('active');
        }

        // creates a downloadable file from the text in the output field
        function downloadOutput() {
            let text = document.getElementById("output-field").value;
            let blob = new Blob([text], { type: "text/plain" });
            let anchor = document.createElement("a");
            anchor.download = "output.json";
            anchor.href = window.URL.createObjectURL(blob);
            anchor.target = "_blank";
            anchor.style.display = "none";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }

        window.onload = createTable;

    </script>
</body>

</html>